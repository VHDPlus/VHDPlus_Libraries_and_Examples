Main
(
    led           : OUT STD_LOGIC := '0';
    RX            : IN  STD_LOGIC;
    TX            : OUT STD_LOGIC;
)
{
    SIGNAL UART_Interface_TX_Enable     : STD_LOGIC;
    SIGNAL UART_Interface_TX_Busy       : STD_LOGIC;
    SIGNAL UART_Interface_TX_Data       : STD_LOGIC_VECTOR (7 DOWNTO 0);
    SIGNAL UART_Interface_RX_Busy       : STD_LOGIC;
    SIGNAL UART_Interface_RX_Data       : STD_LOGIC_VECTOR (7 DOWNTO 0);
    SIGNAL UART_Interface_RX_Error      : STD_LOGIC;
    
    NewComponent UART_Interface
    (
        Baud_Rate     => 9600,
        
        RX            => RX,
        TX            => TX,
        TX_Enable     => UART_Interface_TX_Enable,
        TX_Busy       => UART_Interface_TX_Busy,
        TX_Data       => UART_Interface_TX_Data,
        RX_Busy       => UART_Interface_RX_Busy,
        RX_Data       => UART_Interface_RX_Data,
        RX_Error      => UART_Interface_RX_Error,
    );
    
    SIGNAL BinaryToBcd_Enable : STD_LOGIC;
    SIGNAL BinaryToBcd_Binary : STD_LOGIC_VECTOR (16-1 DOWNTO 0);
    SIGNAL BinaryToBcd_Busy   : STD_LOGIC;
    SIGNAL BinaryToBcd_BCD    : STD_LOGIC_VECTOR (5*4-1 DOWNTO 0);
    
    NewComponent BinaryToBcd
    (
        Bits   => 16, --receiveCount is 0 to 65535
        Digits => 5,  --8bit = 1 to 5 digits
        
        Enable => BinaryToBcd_Enable,
        Binary => BinaryToBcd_Binary,
        Busy   => BinaryToBcd_Busy,
        BCD    => BinaryToBcd_BCD,
    );

    SIGNAL blink_speed : NATURAL := 100;
    
    Process ()
    {
        Thread
        {
            led <= '1';
            Wait(blink_speed*12000);
            led <= '0';
            Wait(blink_speed*12000);
        }

        Thread
        {
            --Create string for received data
            SIGNAL receive_string : String_Type;    --Create string interface
            NewFunction newString (receive_string); --Create RAM for string
            --Create string for final response
            SIGNAL transmit_string : String_Type;
            NewFunction newString (transmit_string);

            --Ask for blink speed---------------------------------------------------------------
            
            SIGNAL askForSpeed : String_Type;                                --Create string interface
            NewFunction assignString (s"\nBlink speed in ms:\n", askForSpeed); --Create ROM with string
            
            --Send "Blink speed in ms:\n" string
            NewFunction printString (askForSpeed, UART_Interface_TX_Data, UART_Interface_TX_Busy, UART_Interface_TX_Enable);

            --Receive response from user
            NewFunction readString (receive_string, UART_Interface_RX_Data, UART_Interface_RX_Busy);
            
            --Save speed and send response-------------------------------------------------------
            
<<<<<<< HEAD
            --Convert response from user to natural
            NewFunction stringToNatural (receive_string, blink_speed);
            
            --Convert speed back to string (to show that convertion was successfull)
            NewFunction naturalToString (blink_speed, receive_string, BinaryToBcd_Enable, BinaryToBcd_Busy, BinaryToBcd_Binary, BinaryToBcd_BCD);

            SIGNAL sendChanged : String_Type;
            NewFunction assignString (s"Speed changed to: ", sendChanged);
            
            --transmit_string = "Speed changed to: " + blink_speed
            NewFunction stringConcat (sendChanged, receive_string, transmit_string);
            
            --Send combined string
            NewFunction printString (transmit_string, UART_Interface_TX_Data, UART_Interface_TX_Busy, UART_Interface_TX_Enable);
        }
    }
}
